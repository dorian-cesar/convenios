<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Postulación a Convenio</title>  
  <link rel="icon" type="image/svg+xml" href="favicon-32x32.png" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script> 
  <link rel="stylesheet" href="convenios.css">
  <script src="regiones.js"></script>
</head>

<body class="p-4">
  <!-- Modal de Selección de Convenio -->
  <div class="modal fade" id="modalConvenio" tabindex="-1" aria-hidden="true" data-bs-backdrop="static"
    data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center p-4">
        <h5 class="modal-title mb-3">¿Qué tipo de convenio deseas postular?</h5>
        <div>
          <button class="btn btn-primary m-2" onclick="seleccionarConvenio('Estudiantes')">Para Estudiantes</button>
          <button class="btn btn-secondary m-2" onclick="seleccionarConvenio('Adulto Mayor')">Adulto Mayor</button>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <img src="image-removebg-preview.png" alt="" class="mb-3">
    <div class="mb-3"><a href="https://www.pullmanbus.cl/">
        <button>Volver</button>
      </a></div>
      
    <h2 id="tituloConvenio" class="text-center mb-4">Selecciona un convenio</h2>
      
    <div class="row">
      <div class="col-md-6">
        <p id="textoInformativo">
          <!-- El contenido se actualizará automáticamente según el convenio -->
        </p>
      </div>

      <div class="col-md-6">
        <form id="formEstudiante" enctype="multipart/form-data">
          <input type="hidden" name="tipo_convenio" id="tipoConvenio">

          <div class="mb-2"><input class="form-control" type="text" name="nombres" placeholder="Nombres" required></div>
          <div class="mb-2"><input class="form-control" type="text" name="apellidos" placeholder="Apellidos" required>
          </div>
          <label for="">Fecha de nacimiento</label>
          <div class="mb-2"><input class="form-control" type="date" name="fechaNacimiento" required></div>
          <div class="mb-2"><input class="form-control" type="text" name="rut" placeholder="RUT" required></div>
          <div class="mb-2">
            <select class="form-control" name="sexo" required>
              <option value="">Sexo</option>
              <option value="Femenino">Femenino</option>
              <option value="Masculino">Masculino</option>
              <option value="Otro">Otro</option>
            </select>
          </div>
          <div class="mb-2"><input class="form-control" type="text" name="telefono" placeholder="Teléfono" required>
          </div>
          <div class="mb-2"><input class="form-control" type="email" name="email" placeholder="Email" required></div>

          <select id="regionSelect" name="region">
            <option value="">Seleccione una región</option>
          </select>

          <select id="comunaSelect" name="comuna" disabled>
            <option value="">Seleccione una comuna</option>
          </select>

          <label for="origen">Origen</label>
          <select id="origen" name="origen">
            <option value="">Cargando ciudades...</option>
          </select>

          <label for="destino">Destino</label>
          <select id="destino" name="destino">
            <option value="">Cargando ciudades...</option>
          </select>


          <div class="mb-2">
            <label>Imagen de Cédula de Identidad</label>
            <input class="form-control" type="file" name="cedula" accept=".jpg,.jpeg,.png,.pdf" required>
          </div>
          <div class="mb-2 d-none" id="certificadoEstudiante">
            <label>Certificado de alumno regular</label>
            <input class="form-control" type="file" name="certificado" accept=".jpg,.jpeg,.png,.pdf" required>
          </div>

          <button type="submit">Enviar Formulario</button>
          <div class="text-center mt-3" id="loader" style="display: none;">
            
            <img decoding="async" src="https://i.gifer.com/ZZ5H.gif" alt="Enviando..." width="50">
            <p>Enviando...</p>
          </div>
        </form>

        <div id="mensaje" class="mt-3"></div>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById('formEstudiante');
    const mensaje = document.getElementById('mensaje');
    const titulo = document.getElementById('tituloConvenio');
    const texto = document.getElementById('textoInformativo');
    const tipoInput = document.getElementById('tipoConvenio');


    const regionSelect = document.getElementById("regionSelect");
    const comunaSelect = document.getElementById("comunaSelect");

    // Llenar regiones
    function cargarRegiones() {
      regionesData.forEach(region => {
        const option = document.createElement("option");
        option.value = region.regionId;
        option.textContent = region.regionName;
        regionSelect.appendChild(option);
      });
    }

    // Llenar comunas según la región seleccionada
    function cargarComunas(regionId) {
      comunaSelect.innerHTML = '<option value="">Seleccione una comuna</option>';
      comunaSelect.disabled = true;

      const region = regionesData.find(r => r.regionId == regionId);
      if (region) {
        const comunas = region.provinces.flatMap(p => p.communes);
        comunas.forEach(comuna => {
          const option = document.createElement("option");
          option.value = comuna.communeId;
          option.textContent = comuna.communeName;
          comunaSelect.appendChild(option);
        });
        comunaSelect.disabled = false;
      }
    }

    // Inicializar
    document.addEventListener("DOMContentLoaded", () => {
      cargarRegiones();

      regionSelect.addEventListener("change", function () {
        cargarComunas(this.value);
      });
    });


    // Mostrar modal al cargar
    window.onload = () => {
      new bootstrap.Modal(document.getElementById('modalConvenio')).show();
    };

    // Elegir convenio
    function seleccionarConvenio(tipo) {
      tipoInput.value = tipo;
      titulo.innerText = `Postulación a Convenio: ${tipo}`;
      const certificadoDiv = document.getElementById("certificadoEstudiante");
      const certificadoInput = certificadoDiv.querySelector("input[name='certificado']");

      if (tipo === 'Estudiantes') {
        texto.innerHTML = `
          <style>
            .step-title::before {
              content: attr(data-step);
              display: inline-flex;
              align-items: center;
              justify-content: center;
              width: 24px;
              height: 24px;
              margin-right: 8px;
              border-radius: 50%;
              background-color: #013ba7; /* Azul */
              color: white; 
              font-weight: bold;
              font-size: 14px;
            }

            .benefit-container p,
            .benefit-container li {
              text-align: justify;
            }
          </style>

          <div class="benefit-container">
            <h3 class="benefit-title">Beneficio Estudiantil 2025</h3>
            <p class="benefit-description">
              El beneficio estudiantil permite a los estudiantes de educación superior viajar a precios preferenciales, de lunes a domingo.
            </p>

            <div class="benefit-section">
              <h4 class="section-title">¿Cómo acceder al beneficio?</h4>
              <p>
                Para acceder al beneficio, debes estar inscrito bajo este convenio llenando el siguiente formulario. 
                También es posible inscribirte presencialmente en nuestras oficinas llevando la documentación necesaria: 
                <strong>certificado de alumno regular</strong> y <strong>cédula de identidad</strong>.
              </p>
            </div>

            <div class="benefit-step">
              <h4 class="step-title" data-step="1">Formulario</h4>
              <p>
                Completa el formulario que se encuentra a continuación y adjunta los documentos solicitados.
                Posterior a esto, enviaremos un email para validar la dirección de correo electrónico registrado.
              </p>
            </div>

            <div class="benefit-step">
              <h4 class="step-title" data-step="2">Revisión</h4>
              <p>
                Al recibir la documentación, Turbus verificará si la solicitud cumple con los requisitos para optar al beneficio. 
                Tu postulación será <span class="highlight">"Aprobada"</span> o <span class="highlight">"Rechazada"</span> (solo en caso de existir alguna anomalía en tus documentos).
                <br><br>
                Los resultados de tu postulación serán notificados vía e-mail.
              </p>
            </div>

            <div class="benefit-step">
              <h4 class="step-title" data-step="3">Validación</h4>
              <p>
                Si tu solicitud fue <span class="highlight-approved">aprobada</span>, activaremos tus datos en nuestros sistemas en un plazo máximo de <strong>72 horas</strong> (posterior a la recepción del e-mail de confirmación). 
                Luego de este plazo, podrás viajar con Turbus haciendo uso de este beneficio.
                <br><br>
                Si tu solicitud fue <span class="highlight-rejected">rechazada</span>, podrás realizar la postulación nuevamente, corrigiendo el error por el cual no fuiste aceptado la primera vez.
              </p>
              <ul class="benefit-list">
                <li>Una vez inscrito/a, podrás comprar tus tickets de dos maneras: <strong>online</strong> o <strong>presencial</strong>. El descuento se reflejará automáticamente al momento de pagar, siempre y cuando hayas escogido el tramo asociado a tu inscripción.</li>
                <li>Es importante recordar que el beneficio es <strong>intransferible</strong> y permite realizar solo <strong>dos trayectos al día</strong>: un viaje de ida y un viaje de regreso, desde los puntos de origen y destino que hayas indicado al momento de inscribirte.</li>
              </ul>
            </div>

            <div class="benefit-step">
              <h4 class="step-title" data-step="4">Beneficio Estudiante 2025</h4>
              <p>
                El beneficio estudiantil 2025 permite a los estudiantes viajar a precios preferenciales, de lunes a domingo, en cualquier horario, desde el <strong>3 de marzo</strong> hasta el <strong>19 de diciembre de 2025</strong>.
              </p>
            </div>
          </div>
        `;
        certificadoDiv.classList.remove("d-none"); // Mostrar
        certificadoInput.required = true; // Hacer obligatorio
      } else {
        texto.innerHTML = `
        <style>
          .step-title::before {
            content: attr(data-step);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            margin-right: 8px;
            border-radius: 50%;
            background-color: #013ba7; /* Azul */
            color: white; 
            font-weight: bold;
            font-size: 14px;
          }

          .benefit-container {
            text-align: justify;
          }
        </style>

        <div class="benefit-container">
          <h3 class="benefit-title">Beneficio Adulto Mayor 2025</h3>
          <p class="benefit-description">
            El beneficio adulto mayor les permite viajar a precios preferenciales, de lunes a domingo.
          </p>

          <div class="benefit-section">
            <h4 class="section-title">¿Cómo acceder al beneficio?</h4>
            <p>
              Para acceder al beneficio, debes estar inscrito bajo este convenio llenando el siguiente formulario. 
              También es posible inscribirte presencialmente en nuestras oficinas llevando la documentación necesaria: 
              <strong>certificado de alumno regular</strong> y <strong>cédula de identidad</strong>.
            </p>
          </div>

          <div class="benefit-step">
            <h4 class="step-title" data-step="1">Formulario</h4>
            <p>
              Completa el formulario que se encuentra a continuación y adjunta los documentos solicitados.
              Posterior a esto, enviaremos un email para validar la dirección de correo electrónico registrado.
            </p>
          </div>

          <div class="benefit-step">
            <h4 class="step-title" data-step="2">Revisión</h4>
            <p>
              Al recibir la documentación, Turbus verificará si la solicitud cumple con los requisitos para optar al beneficio. 
              Tu postulación será <span class="highlight">"Aprobada"</span> o <span class="highlight">"Rechazada"</span> (solo en caso de existir alguna anomalía en tus documentos).
              <br><br>
              Los resultados de tu postulación serán notificados vía e-mail.
            </p>
          </div>

          <div class="benefit-step">
            <h4 class="step-title" data-step="3">Validación</h4>
            <p>
              Si tu solicitud fue <span class="highlight-approved">aprobada</span>, activaremos tus datos en nuestros sistemas en un plazo máximo de <strong>72 horas</strong> 
              (posterior a la recepción del e-mail de confirmación). Luego de este plazo, podrás viajar con Turbus haciendo uso de este beneficio.
              <br><br>
              Si tu solicitud fue <span class="highlight-rejected">rechazada</span>, podrás realizar la postulación nuevamente, corrigiendo el error por el cual no fuiste aceptado la primera vez.
            </p>
            <ul class="benefit-list">
              <li>Una vez inscrito/a, podrás comprar tus tickets de dos maneras: <strong>online</strong> o <strong>presencial</strong>. 
                El descuento se reflejará automáticamente al momento de pagar, siempre y cuando hayas escogido el tramo asociado a tu inscripción.</li>
              <li>Es importante recordar que el beneficio es <strong>intransferible</strong> y permite realizar solo <strong>dos trayectos al día</strong>: 
                un viaje de ida y un viaje de regreso, desde los puntos de origen y destino que hayas indicado al momento de inscribirte.</li>
            </ul>
          </div>

          <div class="benefit-step">
            <h4 class="step-title" data-step="4">Beneficio Adulto Mayor 2025</h4>
            <p>
              El beneficio Adulto Mayor 2025 permite a los usuarios de tercera edad viajar a precios preferenciales, de lunes a domingo, 
              en cualquier horario, durante el periodo de <strong>1 año</strong> desde la fecha de inscripción.
            </p>
          </div>
        </div>

        `;
        certificadoDiv.classList.add("d-none"); // Ocultar
        certificadoInput.required = false; // No obligatorio
      }

      const modal = bootstrap.Modal.getInstance(document.getElementById('modalConvenio'));
      modal.hide();
    }
    document.addEventListener("DOMContentLoaded", () => {
      const origenSelect = document.getElementById("origen");
      const destinoSelect = document.getElementById("destino");

      axios.get("https://preprod-pullmanbus.kupos.cl/api/uniq_cities")
        .then(res => {
          const ciudades = res.data;

          // Limpiar selects
          origenSelect.innerHTML = `<option value="">Selecciona ciudad de origen</option>`;
          destinoSelect.innerHTML = `<option value="">Selecciona ciudad de destino</option>`;

          ciudades.forEach(([nombreCompleto, id]) => {
            const nombreCiudad = nombreCompleto.split(",")[0]; // Quitar ",Chile"

            const optionOrigen = document.createElement("option");
            optionOrigen.value = id;
            optionOrigen.textContent = nombreCiudad;
            origenSelect.appendChild(optionOrigen);

            const optionDestino = document.createElement("option");
            optionDestino.value = id;
            optionDestino.textContent = nombreCiudad;
            destinoSelect.appendChild(optionDestino);
          });
        })
        .catch(error => {
          console.error("Error al obtener ciudades:", error);
          origenSelect.innerHTML = `<option value="">Error al cargar</option>`;
          destinoSelect.innerHTML = `<option value="">Error al cargar</option>`;
        });
    });
    // Enviar formulario con Axios
    form.addEventListener('submit', function (e) {
      e.preventDefault();
      //const formData = new FormData(form);

      const loader = document.getElementById('loader');
      loader.style.display = 'block'; // Mostrar loader


      const regionSelect = document.getElementById("regionSelect");
      const comunaSelect = document.getElementById("comunaSelect");


      const origenSelect = document.getElementById("origen");
      const destinoSelect = document.getElementById("destino");



      // Obtenemos el texto visible (nombre) en lugar del valor (ID)
      const regionNombre = regionSelect.options[regionSelect.selectedIndex].text;
      const comunaNombre = comunaSelect.options[comunaSelect.selectedIndex].text;

      const origenNombre = origenSelect.options[origenSelect.selectedIndex].text;
      const destinoNombre = destinoSelect.options[destinoSelect.selectedIndex].text;







      // Inclúyelos en el objeto de datos
      const formData = new FormData(document.getElementById("formEstudiante"));
      formData.append('region_nombre', regionNombre);
      formData.append('comuna_nombre', comunaNombre);

      formData.append("origen_nombre", origenNombre);
      formData.append("destino_nombre", destinoNombre);




      axios.post('./php/procesar-formulario.php', formData)
        .then(res => {
          mensaje.innerHTML = `<div class="alert alert-success">${res.data}</div>`;
          form.reset();
        })
        .catch(err => {
          mensaje.innerHTML = `<div class="alert alert-danger">Error al enviar el formulario.</div>`;
          console.error(err);
        })
        .finally(() => {
          loader.style.display = 'none'; // Ocultar loader al finalizar
        });
    });
  </script>



</body>

</html>